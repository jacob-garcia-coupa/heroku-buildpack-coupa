#!/usr/bin/env bash
# bin/compile <BUILD_DIR> <CACHE_DIR> <ENV_DIR>

set -eu -o pipefail

AWS_ACCESS_KEY_ID=$(cat $3/AWS_TOOLING_ACCESS_KEY_ID)
AWS_SECRET_ACCESS_KEY=$(cat $3/AWS_TOOLING_ACCESS_KEY_ID)

if [[ "$AWS_SECRET_ACCESS_KEY" == "" || "$AWS_ACCESS_KEY_ID" == "" ]]
then
    echo "AWS credentials must exist in Heroku config to execute Coupa buildpack"
    exit 1
fi

cd /tmp
mkdir rapid7
cd rapid7

curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
./aws/install

aws s3 cp s3://yapta-artifacts/rapid7/linux__Insight_Agent.zip .
unzip linux__Insight_Agent.zip
chmod 0755 agent_installer.sh
./agent_installer.sh install --attributes "heroku,owner=cts-sre"

cd /
rm -rf /tmp/rapid7

rm awscliv2.zip

exit 0
